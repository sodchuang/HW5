# HW5 Worker (Lab Machine) è³‡æ–™åº«æœå‹™è¦æ ¼

## å°ˆæ¡ˆæ¦‚è¿°
æœ¬è¦æ ¼å®šç¾© HW5 åˆ†æ•£å¼æž¶æ§‹ä¸­ Worker (Lab Machine) çš„è³‡æ–™åº«æœå‹™å¯¦ä½œã€‚Worker ç¯€é»žå°ˆè²¬æä¾› PostgreSQL è³‡æ–™åº«æœå‹™ï¼Œä¸åŒ…å«ä»»ä½•æ¥­å‹™é‚è¼¯æˆ–ç”¨æˆ¶ç•Œé¢çµ„ä»¶ã€‚

## åˆ†æ•£å¼ç³»çµ±è§’è‰²å®šç¾©

### ðŸ­ Worker (Lab Machine) - è³‡æ–™å±¤
- **ä¸»è¦è·è²¬**: æä¾› PostgreSQL è³‡æ–™åº«æœå‹™
- **éƒ¨ç½²ç’°å¢ƒ**: å¯¦é©—å®¤æ©Ÿå™¨ (å…·å‚™ç©©å®šç¶²è·¯å’Œå„²å­˜)
- **æœå‹™ç¯„åœ**: åƒ…è³‡æ–™å­˜å–å±¤ï¼Œä¸æä¾›æ¥­å‹™é‚è¼¯
- **ç¶²è·¯æš´éœ²**: 5432 åŸ ä¾› Manager é€£æŽ¥

### ðŸ’» Manager (Student Laptop) - æ‡‰ç”¨å±¤
- **ä¸»è¦è·è²¬**: Web ç•Œé¢ã€API æœå‹™ã€æ¥­å‹™é‚è¼¯
- **éƒ¨ç½²ç’°å¢ƒ**: å­¸ç”Ÿç­†è¨˜åž‹é›»è…¦
- **æœå‹™ç¯„åœ**: å®Œæ•´çš„ Web æ‡‰ç”¨ (80:80)
- **è³‡æ–™å­˜å–**: é€£æŽ¥åˆ° Worker è³‡æ–™åº«

## ç³»çµ±æž¶æ§‹åœ–
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Manager (Student Laptop)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Nginx     â”‚    â”‚        FastAPI              â”‚ â”‚  
â”‚  â”‚   Web UI    â”‚â—„â”€â”€â–ºâ”‚     Business Logic          â”‚ â”‚
â”‚  â”‚   Port 80   â”‚    â”‚     Name Management         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ 
                                  â”‚ PostgreSQL Protocol
                                  â”‚ (Port 5432)
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Worker (Lab Machine)                     â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            PostgreSQL 15 Alpine                â”‚  â”‚
â”‚  â”‚                                                 â”‚  â”‚
â”‚  â”‚  Database: worker_names                         â”‚  â”‚
â”‚  â”‚  User: worker / Password: worker_password       â”‚  â”‚
â”‚  â”‚  Port: 5432 (External Access)                  â”‚  â”‚
â”‚  â”‚                                                 â”‚  â”‚
â”‚  â”‚  Persistent Storage:                            â”‚  â”‚
â”‚  â”‚  /var/lib/postgres-data                        â”‚  â”‚
â”‚  â”‚  (æˆ– NFS æŽ›è¼‰è·¯å¾‘)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Worker æœå‹™è¦æ ¼

### æ ¸å¿ƒåŠŸèƒ½
- **è³‡æ–™åº«å¼•æ“Ž**: PostgreSQL 15 (Alpine Linux åŸºç¤Ž)
- **è³‡æ–™æŒä¹…åŒ–**: æœ¬åœ°å„²å­˜æˆ– NFS ç¶²è·¯å„²å­˜
- **é«˜å¯ç”¨æ€§**: Docker Swarm å®¹å™¨ç·¨æŽ’
- **ç›£æŽ§å¥æª¢**: PostgreSQL readiness probe
- **ç¶²è·¯æœå‹™**: åƒ…æš´éœ² 5432 è³‡æ–™åº«é€£æŽ¥åŸ 

## åŠŸèƒ½éœ€æ±‚èˆ‡å¯¦ä½œ

### ðŸ—„ï¸ è³‡æ–™åº«æœå‹™éœ€æ±‚
| éœ€æ±‚é …ç›® | è¦æ ¼èªªæ˜Ž | å¯¦ä½œæ–¹å¼ |
|---------|----------|----------|
| **è³‡æ–™å¼•æ“Ž** | PostgreSQL 15+ | postgres:15-alpine Docker æ˜ åƒ |
| **è³‡æ–™æŒä¹…åŒ–** | æ”¯æ´å®¹å™¨é‡å•Ÿå¾Œè³‡æ–™ä¿å­˜ | Docker Volume æŽ›è¼‰ |
| **ç¶²è·¯å­˜å–** | ä¾›å¤–éƒ¨ Manager é€£æŽ¥ | æš´éœ² 5432 åŸ  |
| **è³‡æ–™åˆå§‹åŒ–** | è‡ªå‹•å»ºç«‹è³‡æ–™è¡¨çµæ§‹ | init.sql åˆå§‹åŒ–è…³æœ¬ |
| **å¥åº·ç›£æŽ§** | æœå‹™å¯ç”¨æ€§æª¢æŸ¥ | pg_isready å¥åº·æª¢æŸ¥ |
| **æ•ˆèƒ½èª¿æ ¡** | é©ç•¶çš„è¨˜æ†¶é«”å’Œé€£ç·šè¨­å®š | Docker è³‡æºé™åˆ¶ |

### ðŸ“Š è³‡æ–™æ¨¡åž‹è¨­è¨ˆ

#### names è³‡æ–™è¡¨
```sql
CREATE TABLE names (
    id SERIAL PRIMARY KEY,                    -- è‡ªå¢žä¸»éµ
    name VARCHAR(50) NOT NULL,                -- åå­— (æœ€å¤§50å­—å…ƒ)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- å»ºç«‹æ™‚é–“
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP   -- æ›´æ–°æ™‚é–“
);

-- æ•ˆèƒ½ç´¢å¼•
CREATE INDEX idx_names_created_at ON names(created_at);
CREATE INDEX idx_names_name ON names(name);
```

#### çµ±è¨ˆæª¢è¦–
```sql
CREATE VIEW names_stats AS
SELECT 
    COUNT(*) as total_names,
    MIN(created_at) as first_created,
    MAX(created_at) as last_created,
    COUNT(DISTINCT DATE(created_at)) as days_with_data
FROM names;
```

### ðŸ”Œ é€£æŽ¥è³‡è¨Š
| åƒæ•¸ | å€¼ | èªªæ˜Ž |
|------|----|----- |
| **ä¸»æ©Ÿä½å€** | `{LAB_MACHINE_IP}` | Worker æ©Ÿå™¨çš„ IP ä½å€ |
| **é€£æŽ¥åŸ ** | `5432` | PostgreSQL æ¨™æº–åŸ  |
| **è³‡æ–™åº«å** | `worker_names` | å°ˆæ¡ˆè³‡æ–™åº« |
| **ä½¿ç”¨è€…å** | `worker` | è³‡æ–™åº«ä½¿ç”¨è€… |
| **å¯†ç¢¼** | `worker_password` | èªè­‰å¯†ç¢¼ |
| **é€£æŽ¥å­—ä¸²** | `postgresql://worker:worker_password@{LAB_MACHINE_IP}:5432/worker_names` | å®Œæ•´é€£æŽ¥å­—ä¸² |

## æŠ€è¡“è¦æ ¼

### ðŸ³ å®¹å™¨åŒ–é…ç½®
| é…ç½®é …ç›® | è¦æ ¼ | èªªæ˜Ž |
|---------|------|------|
| **åŸºç¤Žæ˜ åƒ** | `postgres:15-alpine` | è¼•é‡åŒ– PostgreSQL 15 |
| **å®¹å™¨åç¨±** | `worker-db-stack_postgres-db` | Docker Swarm æœå‹™å |
| **é‡å•Ÿç­–ç•¥** | `on-failure` | å¤±æ•—æ™‚è‡ªå‹•é‡å•Ÿ |
| **å‰¯æœ¬æ•¸é‡** | `1` | å–®å¯¦ä¾‹éƒ¨ç½² |
| **éƒ¨ç½²ç´„æŸ** | `node.role == worker` | å¼·åˆ¶éƒ¨ç½²åœ¨ worker ç¯€é»ž |

### ðŸ”§ ç’°å¢ƒè®Šæ•¸
```bash
POSTGRES_DB=worker_names          # è³‡æ–™åº«åç¨±
POSTGRES_USER=worker              # è³‡æ–™åº«ä½¿ç”¨è€…
POSTGRES_PASSWORD=worker_password # è³‡æ–™åº«å¯†ç¢¼
PGDATA=/var/lib/postgresql/data/pgdata  # è³‡æ–™ç›®éŒ„
```

### ðŸ’¾ å„²å­˜é…ç½®
| å„²å­˜é¡žåž‹ | è·¯å¾‘ | ç”¨é€” |
|---------|------|------|
| **è³‡æ–™å·** | `/var/lib/postgres-data` | ä¸»è¦è³‡æ–™å„²å­˜ |
| **åˆå§‹åŒ–è…³æœ¬** | `./db/init.sql` | è³‡æ–™åº«åˆå§‹åŒ– |
| **å·é¡žåž‹** | `local bind mount` | æœ¬åœ°ç¶å®šæŽ›è¼‰ |
| **å‚™ç”¨é¸é …** | `NFS ç¶²è·¯å„²å­˜` | å¯é¸çš„ç¶²è·¯å„²å­˜ |

### ðŸŒ ç¶²è·¯é…ç½®
```yaml
networks:
  worker_net:
    driver: overlay          # Docker Swarm overlay ç¶²è·¯
    attachable: true         # å…è¨±å¤–éƒ¨å®¹å™¨é€£æŽ¥
    ipam:
      config:
        - subnet: 10.2.0.0/24  # å…§éƒ¨å­ç¶²æ®µ
```

### âš¡ è³‡æºé™åˆ¶
| è³‡æºé¡žåž‹ | é™åˆ¶å€¼ | ä¿è­‰å€¼ | èªªæ˜Ž |
|---------|--------|--------|------|
| **è¨˜æ†¶é«”** | 1GB | 512MB | é˜²æ­¢è³‡æºéŽåº¦ä½¿ç”¨ |
| **CPU** | ç„¡é™åˆ¶ | ç„¡ä¿è­‰ | æ ¹æ“šç³»çµ±è² è¼‰å‹•æ…‹åˆ†é… |

### ðŸ¥ å¥åº·æª¢æŸ¥
```bash
# æª¢æŸ¥å‘½ä»¤
pg_isready -U worker -d worker_names

# æª¢æŸ¥é–“éš”
interval: 30s     # æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
timeout: 10s      # 10ç§’è¶…æ™‚
retries: 5        # æœ€å¤šé‡è©¦5æ¬¡
start_period: 60s # å•Ÿå‹•å¯¬é™æœŸ60ç§’
```

## éƒ¨ç½²ç’°å¢ƒéœ€æ±‚

### ðŸ–¥ï¸ ç¡¬é«”éœ€æ±‚
| é …ç›® | æœ€ä½Žéœ€æ±‚ | å»ºè­°è¦æ ¼ |
|------|---------|----------|
| **CPU** | 2 æ ¸å¿ƒ | 4 æ ¸å¿ƒä»¥ä¸Š |
| **è¨˜æ†¶é«”** | 2GB | 4GB ä»¥ä¸Š |
| **å„²å­˜ç©ºé–“** | 10GB | 50GB ä»¥ä¸Š |
| **ç¶²è·¯** | 100Mbps | 1Gbps |

### ðŸ› ï¸ è»Ÿé«”éœ€æ±‚
- **ä½œæ¥­ç³»çµ±**: Windows 10/11, Windows Server 2019+, æˆ– Linux
- **å®¹å™¨å¹³å°**: Docker Engine 20.10+
- **ç·¨æŽ’å·¥å…·**: Docker Swarm æ¨¡å¼
- **ç¶²è·¯**: ç©©å®šçš„å…§ç¶²é€£æŽ¥

### ðŸš€ éƒ¨ç½²æ­¥é©Ÿ
1. **ç’°å¢ƒæº–å‚™**
   ```powershell
   # å•Ÿå‹• Docker Swarm
   docker swarm init --advertise-addr {LAB_MACHINE_IP}
   ```

2. **è³‡æ–™ç›®éŒ„æº–å‚™**
   ```powershell
   # å»ºç«‹è³‡æ–™ç›®éŒ„ (Linux/WSL)
   sudo mkdir -p /var/lib/postgres-data
   sudo chown -R 999:999 /var/lib/postgres-data
   
   # æˆ–ä½¿ç”¨æœ¬åœ°ç›®éŒ„ (Windows)
   mkdir postgres-data
   ```

3. **æœå‹™éƒ¨ç½²**
   ```powershell
   # éƒ¨ç½²è³‡æ–™åº«æœå‹™
   docker stack deploy -c docker-compose-hw5.yml worker-db-stack
   ```

4. **é©—è­‰éƒ¨ç½²**
   ```powershell
   # æª¢æŸ¥æœå‹™ç‹€æ…‹
   docker service ls
   
   # æ¸¬è©¦è³‡æ–™åº«é€£æŽ¥
   .\test-db.ps1
   ```

## Manager æ•´åˆèªªæ˜Ž

### ðŸ”— é€£æŽ¥è¨­å®š
Manager (Student Laptop) éœ€è¦åœ¨å…¶æ‡‰ç”¨ç¨‹å¼ä¸­é…ç½®ä»¥ä¸‹é€£æŽ¥è³‡è¨Šï¼š

```python
# Python ç¯„ä¾‹ (SQLAlchemy)
DATABASE_URL = "postgresql://worker:worker_password@{LAB_MACHINE_IP}:5432/worker_names"

# Node.js ç¯„ä¾‹
const db_config = {
    host: '{LAB_MACHINE_IP}',
    port: 5432,
    database: 'worker_names',
    user: 'worker',
    password: 'worker_password'
};
```

### ðŸ›¡ï¸ å®‰å…¨æ€§è€ƒé‡
- **ç¶²è·¯å®‰å…¨**: å»ºè­°åœ¨å…§ç¶²ç’°å¢ƒéƒ¨ç½²ï¼Œé¿å…æš´éœ²åˆ°å…¬å…±ç¶²è·¯
- **èªè­‰æ©Ÿåˆ¶**: å¯æ ¹æ“šéœ€è¦æ›´æ›é è¨­å¯†ç¢¼
- **è³‡æ–™å‚™ä»½**: å»ºè­°å®šæœŸå‚™ä»½ postgres-data ç›®éŒ„
- **ç›£æŽ§å‘Šè­¦**: æ•´åˆç›£æŽ§ç³»çµ±è¿½è¹¤è³‡æ–™åº«ç‹€æ…‹

## ç¶­è­·æ“ä½œ

### ðŸ“Š ç›£æŽ§æŒ‡ä»¤
```powershell
# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker service ps worker-db-stack_postgres-db

# æŸ¥çœ‹è³‡æºä½¿ç”¨
docker stats

# æª¢è¦–æ—¥èªŒ
docker service logs worker-db-stack_postgres-db
```

### ðŸ”„ å‚™ä»½èˆ‡é‚„åŽŸ
```bash
# è³‡æ–™å‚™ä»½
docker exec postgres-container pg_dump -U worker worker_names > backup.sql

# è³‡æ–™é‚„åŽŸ  
docker exec -i postgres-container psql -U worker worker_names < backup.sql
```

### ðŸ› ï¸ æ•…éšœæŽ’é™¤
| å•é¡Œ | å¯èƒ½åŽŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|------|---------|----------|
| é€£æŽ¥è¢«æ‹’çµ• | æœå‹™æœªå•Ÿå‹• | `docker service ls` æª¢æŸ¥ç‹€æ…‹ |
| è³‡æ–™éºå¤± | å·æŽ›è¼‰å¤±æ•— | æª¢æŸ¥ postgres-data ç›®éŒ„æ¬Šé™ |
| æ•ˆèƒ½ç·©æ…¢ | è¨˜æ†¶é«”ä¸è¶³ | å¢žåŠ  Docker è¨˜æ†¶é«”é™åˆ¶ |